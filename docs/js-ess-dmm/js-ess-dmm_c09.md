`第9章`

# `调试JavaScript`

`本章内容`

![Bullet](images/check.png) `使用控制台调试错误`

![Bullet](images/check.png) `设置断点`

![Bullet](images/check.png) `逐步调试JavaScript代码`

`JavaScript`和现代网页浏览器提供了大量顶级的调试工具，可以减少程序问题解决的负担。在本章中，你将深入了解这些工具，探索它们如何帮助你发现并修复大多数编程错误。你还将研究一些技巧和方法，这些方法能帮助你在编写代码时避免错误。

所有主要的网页浏览器都配备了复杂的调试工具，可以让你的网页开发工作变得更加轻松和理智。大多数网页开发者使用`Google Chrome`来调试脚本，因此在本章中，我将重点介绍该浏览器。但在本节中，我会给你概述所有主要浏览器中可用的工具，并介绍如何使用这些工具。

下面是如何在`Chrome`、`Firefox`、`Microsoft Edge`和`Safari`中打开网页开发工具：

+   `Windows版Chrome:` 点击`自定义和控制Google Chrome`（地址栏右侧的三个垂直点），然后选择`更多工具 ⇒ 开发者工具`。快捷键：`Ctrl+Shift+I`。

+   `Mac版Chrome:` 选择`查看 ⇒ 开发者 ⇒ 开发者工具`。快捷键：`Option+⌘    +I`。

+   `Windows版Firefox:` 点击`打开应用菜单`（工具栏右侧的三个横线），然后选择`更多工具 ⇒ Web开发者工具`。快捷键：`Ctrl+Shift+I`。

+   `Mac版Firefox:` 选择`工具 ⇒ 浏览器工具 ⇒ Web开发者工具`。快捷键：`Option+⌘    +I`。

+   `Microsoft Edge:` 点击`设置与更多`（地址栏右侧的三个垂直点），然后选择`更多工具 ⇒ 开发者工具`。快捷键：`Ctrl+Shift+I`。

+   `Safari:` 选择`开发 ⇒ 显示Web检查器`。快捷键：`Option+⌘    +I`。如果没有开发菜单，选择`Safari ⇒ 设置`，点击`高级`标签页，然后勾选`在菜单栏中显示开发菜单`复选框。

这些开发工具的功能有所不同，但每个工具都提供了一组基本工具，这些工具是你最常使用的。以下是这些基本网页开发工具：

+   `HTML查看器:` 这个标签页（在Firefox中叫做`Inspector`，在其他浏览器中叫做`Elements`）显示了网页使用的HTML源代码。当你将鼠标悬停在某个标签上时，浏览器会高亮显示该元素，并显示它的宽度和高度，如[图9-1](#c09-fig-0001)所示。当你点击某个标签时，浏览器会显示与该标签应用的CSS样式，以及标签的框尺寸（同样，请参考[图9-1](#c09-fig-0001)）。

+   `控制台:` 这个标签页让你查看错误消息、日志消息、测试表达式和执行语句。我将在下一节中更详细地介绍`控制台`。

+   `调试工具:` 这个选项卡（在Firefox中称为`Debugger`，在其他浏览器中称为`Sources`）使你能够暂停代码执行、逐步执行代码、观察变量和属性的值等等。这是最重要的JavaScript调试工具，因此我在本章后面详细介绍它。

+   `Network:` 这个选项卡告诉你加载网页中引用的每个文件需要多长时间。如果你发现页面加载缓慢，这个选项卡可以帮助你找到瓶颈。

+   `Web storage:` 这个选项卡（在Chrome和Edge中称为`Application`，在Firefox和Safari中称为`Storage`）使你能够检查存储在浏览器中的数据。

![Chrome的Elements选项卡的快照。选中的元素被突出显示，并且提到了元素的宽度和高度。](images/9781394263219-fg0901.png)

[图9-1:](#rc09-fig-0001) HTML查看器，例如Chrome的`Elements`选项卡，使你能够检查每个元素的样式和框架尺寸。  ## 调试101：使用控制台

如果你的网页行为异常——例如，页面为空或缺少元素——你应该首先检查HTML代码以确保它是正确的。（常见的HTML错误包括未用大于号（`>`）结束标签、未包含结束标签，以及缺少属性值的结束引号。）如果你的HTML检查通过，很有可能你的JavaScript代码存在问题。你怎么知道？首先要去控制台窗口查看。

控制台是一个交互式浏览器窗口，显示警告和错误，显示`console.log()`语句的输出，并使你能够执行表达式和语句，而不必运行整个脚本。控制台是最方便的网页浏览器调试工具之一，因此你需要熟悉它。

### 获取控制台显示

要显示控制台，打开你网页浏览器的开发工具，然后点击控制台选项卡。你还可以使用以下键盘快捷键：

+   `Chrome for Windows:` 按`Ctrl+Shift+J`。

+   `Chrome for Mac:` 按`Option+⌘    +J`。

+   `Firefox for Windows:` 按`Ctrl+Shift+K`。

+   `Firefox for Mac:` 按`Option+⌘    +K`。

+   `Microsoft Edge:` 按`Ctrl+Shift+J`。

+   `Safari:` 按`Option+⌘    +C`。  ### 在控制台中打印程序数据

你可以使用`console.log()`方法的特殊`Console`对象在控制台中打印文本和表达式值：

`console.log(output)`

`注意:` `output`是你想在控制台中打印的表达式。

`output`表达式可以是文本字符串、变量、对象属性、函数结果或这些的任何组合。

![提示](images/tip.png) 你还可以使用方便的`console.table()`方法以易于阅读的表格格式输出数组或对象的值：

`console.table(output)`

`注意:` `output`是你想在控制台中查看的数组或对象（作为变量或字面量）。

出于调试目的，你最常使用`Console`来监视变量、对象属性和表达式的值。也就是说，当你的代码设置或更改某个值时，你插入一个`console.log()`（或`console.table()`）语句来输出新值。当脚本执行完成后，你可以打开`Console`，然后查看记录的值。

`Console`的一个伟大特性是它是交互式的，这意味着你不仅可以阅读浏览器或你的`console.log()`语句生成的消息，还可以直接在`Console`中输入代码。也就是说，你可以使用`Console`执行表达式和语句。这个特性的用途很多：

+   你可以尝试一些实验性的表达式或语句，以确定它们对脚本的影响。

+   当脚本暂停时，你可以输出变量或属性的当前值。

+   当脚本暂停时，你可以更改变量或属性的值。例如，如果你注意到某个值为零的变量即将用作除数，你可以将该变量更改为非零值，以避免脚本崩溃。

+   当脚本暂停时，你可以运行一个函数或方法，以确认它在当前条件下是否按预期工作。

每个浏览器的`Console`标签都包含一个文本框（通常由大于号`>`提示标记），你可以在其中输入表达式或语句。

![提示](images/tip.png) 你可以通过用分号分隔每个语句来在`Console`中执行多个语句。例如，你可以通过输入类似于以下的语句来测试`for…`循环：

``for (let i=1; i < 10; i += 1){console.log(i**2); console.log(i**3);}``

![提示](images/tip.png) 如果你想在`Console`中重复先前的代码执行，或者如果你想运行一些与之前执行的代码非常相似的代码，你可以回顾当前浏览器会话中使用的语句和表达式。按`Up Arrow`键可以向后滚动查看之前执行的代码；按`Down Arrow`键可以向前滚动查看你的代码。 ## 将代码置于断点模式

在代码中途暂停可以让你检查某些元素，例如变量和属性的当前值。它还允许你逐条执行程序代码，以便监控脚本的流程。

当你暂停代码时，JavaScript进入`break mode`，这意味着浏览器显示其调试工具并高亮当前语句（JavaScript将要执行的下一条语句）。`[图9-2](#c09-fig-0002)`显示了Chrome调试器（`Sources`标签）中的`break mode`脚本。

![网页浏览器的快照，显示其调试工具并突出显示将要执行的语句。](images/9781394263219-fg0902.png)

[图9-2:](#rc09-fig-0002) 当你调用断点模式时，网页浏览器显示其调试工具并突出显示将要执行的下一条语句。

### 调用断点模式

`JavaScript`为你提供了两种进入断点模式的方法：

+   通过设置断点

+   通过使用`debugger`语句

#### 设置断点

如果你大致知道错误或逻辑缺陷发生的位置，可以通过设置`断点`来在脚本中的特定语句处进入断点模式。设置断点的步骤如下：

1.  显示你网页浏览器的开发者工具，并切换到调试工具（例如`Chrome`中的`Sources`标签）。

1.  打开包含你想调试的`JavaScript`代码的文件。

    如何操作取决于浏览器：在`Chrome`（以及大多数浏览器）中，你有两种选择：

    +   在左侧窗格中，点击`HTML`文件（如果你的`JavaScript`代码位于`HTML`文件中的`script`元素内）或`JavaScript`（`.js`）文件（如果你的代码位于外部`JavaScript`文件中）。

    +   按`Ctrl+P`（Windows）或`⌘+P`（macOS），然后点击弹出列表中的文件。

1.  定位到你希望进入断点模式的语句。

    `JavaScript`会执行每一行代码，直到但不包括该语句。

1.  点击语句左侧的行号设置断点，如[图9-3](#c09-fig-0003)所示。

![浏览器调试工具的截图，点击行号为该语句设置断点。](images/9781394263219-fg0903.png)

[图9-3：](#rc09-fig-0003) 在浏览器的调试工具中，点击行号为该语句设置断点。

要删除一个断点，大多数浏览器提供三种选择：

+   要暂时禁用一个断点，可以在`断点`列表中取消勾选该断点的复选框。

+   ![9781394263219-ma0901](images/9781394263219-ma0901.png)要暂时禁用所有断点，点击`停用断点`按钮。`Chrome`版本的此按钮如图所示，位于边栏。再次点击此按钮可重新启用所有断点。

+   要完全删除断点，点击该语句的行号。  #### 添加`debugger`语句

在开发网页时，你经常会通过发送不同的测试值或在不同条件下测试脚本的鲁棒性。在很多情况下，你可能希望进入断点模式，确保一切正常。你可以在特定的语句处设置断点，但如果关闭文件，断点会丢失。为了更持久一点，你可以在脚本中包含一个`debugger`语句。每当`JavaScript`遇到`debugger`语句时，它会自动进入断点模式。

下面是一段包含`debugger`语句的代码：

`// 将语句添加到 <div> document.querySelector('div').innerHTML = sentence; // 生成随机颜色（使用小于128的值保持文字颜色较深） const randomRed = parseInt(Math.random() * 128); const randomGreen = parseInt(Math.random() * 128); const randomBlue = parseInt(Math.random() * 128); debugger;`  ### 退出断点模式

要退出断点模式，你可以在浏览器的调试工具中使用以下任意方法：

+   ![9781394263219-ma0902](images/9781394263219-ma0902.png) 点击`继续`按钮。Chrome版本的此按钮如图所示，位于边栏。

+   按下浏览器的`Resume`快捷键。在`Chrome`（以及大多数浏览器）中，可以按`F8`，或者按`Ctrl+\`（Windows）或`⌘    +\`（macOS）。 ## 逐步执行你的代码

最常见（且最有用）的调试技巧之一是逐语句执行代码。这样可以让你更好地理解程序流，确保诸如循环和函数调用等部分能够正确执行。你可以使用四种技巧：

+   一次执行一个语句

+   进入一些代码

+   跳过某些代码

+   跳出某些代码

### 一次执行一个语句

最常见的逐步执行代码的方式是逐条执行语句。在断点模式下，逐条执行语句意味着两件事：

+   执行当前语句，然后在下一个语句处暂停。

+   如果当前要执行的语句是一个函数调用，逐步执行会将你带入该函数并在函数的第一条语句处暂停。然后你可以继续逐步执行函数，直到执行完最后一条语句，浏览器会将你带回函数调用后的语句。

要逐语句执行代码，请设置一个断点，然后在代码进入断点模式后，执行以下任一操作来逐个执行语句：

+   ![9781394263219-ma0903](images/9781394263219-ma0903.png) 点击`Step`按钮。Chrome版本的此按钮显示在边栏中。

+   按下浏览器的`Step`快捷键。在`Chrome`（以及大多数浏览器，除了`Firefox`，在本篇写作时不支持`Step`，请改用`Step Into`按钮）中，按`F9`。

持续逐步执行直到脚本结束，或者直到你准备好恢复正常执行（通过点击`Resume`）。 ### 进入一些代码

在所有主流浏览器中（除了`Firefox`），进入一些代码与逐语句执行代码是完全相同的。差别出现在语句异步执行时（即，它在一些延迟后执行操作，而不是立刻执行）。

为了理解其区别，考虑以下代码（我在左侧添加了行号；这些不是代码的一部分）：

`1 setTimeout(() => { 2 console.log('Inside the setTimeout() block!'); 3 }, 5000); 4 console.log('Outside the setTimeout) block!');`

这段代码使用`setTimeout()`在五秒后执行一个匿名函数。假设你在`setTimeout()`语句（第1行）处进入了断点模式。如果在这里使用`Step`与`Step Into`，会发生什么呢？看看吧：

+   `Step:` 点击`Step`按钮不会将你带到第2行，正如你可能期望的那样。相反，由于`setTimeout()`是异步的，`Step`本质上忽略了匿名函数，直接跳转到第4行。

+   `Step Into:` 点击`Step Into`按钮`确实`将你带到第2行，但仅在指定的延迟（此情况下为五秒）之后。然后你可以根据需要逐步进入匿名函数。

要进入你的代码，设置一个断点，然后在代码进入断点模式后，执行以下任一操作：

+   ![9781394263219-ma0904](images/9781394263219-ma0904.png) `点击Step Into按钮。` Chrome的这个按钮在边栏中显示。

+   `按下浏览器的Step Into快捷键。` 在Chrome（以及大多数浏览器）中，可以按`F11`或者按`Ctrl+;`（Windows）或`⌘    +;`（macOS）。

![Remember](images/remember.png) 我在这里对`Step Into`的描述并不适用于Firefox（至少在我写这篇时如此）。相反，Firefox的`Step Into`功能类似于我在上一节中描述的`Step`功能。 ### 跳过一些代码

一些语句调用其他函数。如果你不想逐步进入被调用的函数，你可以跳过它。跳过一个函数意味着 JavaScript 正常执行该函数，然后在下一个语句`之后`恢复断点模式。

要跳过一个函数，首先可以逐行执行代码直到到达你想跳过的函数调用，或者在函数调用上设置一个断点并刷新网页。当你处于断点模式时，可以使用以下任一技术来跳过函数：

+   ![9781394263219-ma0905](images/9781394263219-ma0905.png) `点击 Step Over 按钮`。Chrome 的这个按钮在边栏中显示。

+   `按浏览器的 Step Over 快捷键`。在 Chrome（以及大多数浏览器）中，可以按 `F10` 或者按 `Ctrl+'`（Windows）或 `⌘    +'`（macOS）。 ### 跳出一些代码

我总是意外地进入我宁愿跳过的函数。如果函数很短，我就逐步执行它直到回到原始代码。如果函数很长，我不想浪费时间逐行执行每个语句。相反，我使用以下任一方法调用 `Step Out` 功能：

+   ![9781394263219-ma0906](images/9781394263219-ma0906.png) `点击 Step Out 按钮`。Chrome 的这个按钮在边栏中显示。

+   `按浏览器的 Step Out 快捷键`。在 Chrome（以及大多数浏览器）中，可以按 `Shift+F11` 或者按 `Ctrl+Shift+;`（Windows）或 `⌘    +Shift+;`（macOS）。

JavaScript 执行函数的其余部分，然后在函数调用后的第一行重新进入断点模式。
