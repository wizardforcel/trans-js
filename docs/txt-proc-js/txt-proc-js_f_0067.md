| 食谱 55 | 验证密码强度 |
| --- | --- |

### 任务

假设你的任务是检查用户在注册网站用户账户时输入的密码是否能够抵御猜测或暴力破解攻击。通常，公司会建立一项密码策略，概述密码创建和使用的标准，要求包括：

+   密码至少需要有 8 个字符或更多

+   包含大小写字母

+   包含一个或多个数字

+   包含特殊字符，如 @、#、$ 等

+   禁止使用密码黑名单中的词语

+   禁止使用与用户个人信息相关的词语

+   禁止使用公司名称或其缩写

+   禁止使用与出生日期、车牌号码、电话号码或其他常用数字匹配的密码

使用的具体指南可能会根据业务和系统的不同而显著变化。因此，本示例提供了多种正则表达式，可以作为构建块，根据需要创建定制的验证规则。

对于匹配非英文字符/数字，请使用 Unicode 变体（由 \p{…} 表示）并带上 u 标志。

### 解决方案

包含至少一个 ASCII 大写字母（回顾一下 (?= ...) 是正向先行断言）：

|   | (?=.*[A-Z]) |
| --- | --- |

包含至少一个 Unicode 大写字母：

|   | (?=.*\p{Uppercase}) |
| --- | --- |
| \p{...} 需要一个标志 |
| --- |
| ![images/aside-icons/warning.png](images/aside-icons/warning.png) | 别忘了在匹配 Unicode 字符时使用 u 标志。 |

包含至少一个 ASCII 小写字母：

|   | (?=.*[a-z]) |
| --- | --- |

包含至少一个 Unicode 小写字母：

|   | (?=.*\p{Lowercase}) |
| --- | --- |

包含至少一个 Unicode 字母：

|   | (?=.*\p{Alphabetic}) |
| --- | --- |

包含至少一个数字：

|   | (?=.*\d) |
| --- | --- |

包含至少一个 Unicode 大写字母：

|   | (?=.*\p{Number}) |
| --- | --- |

仅包含 ASCII 可打印字符：

|   | (?=.*[ -~]) |
| --- | --- |
| 什么是 ASCII 可打印字符？ |
| --- |
| ![images/aside-icons/info.png](images/aside-icons/info.png) | ASCII可打印字符由95个字符组成，你可以在QWERTY键盘上找到它们。^([[34]](f_0087.xhtml#FOOTNOTE-34)) (?=.*[ -~]) 将匹配所有从空格到波浪号的ASCII可打印字符，排除删除字符。 |

包含一个或多个ASCII标点符号或空格：

|   | (?=.*[ !"#$%&'()*+,\-./:;<=>?@[\\\]^_`{&#124;}~]) |
| --- | --- |

包含除了ASCII字母和数字以外的任何字符：

|   | (?=.*[^A-Za-z0-9]) |
| --- | --- |

要求最少8个字符：

|   | (?=.{8,}) |
| --- | --- |

要求最少8个字符，最多32个字符：

|   | (?=.{8,32}) |
| --- | --- |

包含两个或更多的数字/字母：

|   | (?=(.*[a-z]){2,}) // 至少2个小写ASCII字母 |
| --- | --- |
|   | (?=(.*[A-Z]){2,}) // 至少2个大写ASCII字母 |
|   | (?=(.*[0-9]){2,}) // 至少2个ASCII数字 |

你也可以使用这种技巧来要求多个标点符号、Unicode字符等等。

#### 示例：最少八个字符，一个ASCII字母和一个特殊字符：

[part_3/validating_passwords/pass_ex1.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/validating_passwords/pass_ex1.js)

|   | **let** re = */^**(?=**.***[**A-Za-z**])(?=**.***[* *!"#$%&'()*+,**\-**.**/**:;<=>?@[**\\\]**^_`{&#124;}~**])**.**{8,}**$/*; |
| --- | --- |
|   |  |
|   | re.test(*"abcdefgh"*); *// → false* |
|   | re.test(*"A7#cdefgh"*); *// → true* |

#### 示例：最少八个字符，两个Unicode数字和两个Unicode字母：

[part_3/validating_passwords/pass_ex2.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/validating_passwords/pass_ex2.js)

|   | **let** re = */^**(?=(**.***\p**{Alphabetic}**){2,})(?=(**.***\p**{Number}**){2,})**.**{8,}**$/*u; |
| --- | --- |
|   |  |
|   | re.test(*"a7bcdefgh"*); *// → false* |
|   | re.test(*"a77bcdefg"*); *// → true* |

#### 示例：禁止密码中列出的单词：

虽然你可以使用正则表达式来完成这项任务，但 JavaScript 已经提供了一种内置方法，可以简化这个过程：

[part_3/validating_passwords/pass_ex3.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/validating_passwords/pass_ex3.js)

|   | **let** blocklist = [*"asdasd"*, *"qwerty"*, *"password"*, *"abc123"*, *"qwerty123"*, |
| --- | --- |
|   | *"iloveyou"*, *"football"*, *"princess"*, *"superman"*, *"computer"*]; |
|   |  |
|   | **let** pass = *"superman"*; |
|   |  |
|   | blocklist.includes(pass); *// → true* |
| 允许多行密码 |
| --- |
| ![images/aside-icons/tip.png](images/aside-icons/tip.png) | 为确保你的正则表达式在处理包含换行符的复杂密码时能正常工作，请使用 s 标志（参见配方 42，[*强制 . 匹配换行符的 s 标志*](f_0053.xhtml#rcp.flag_s)）。 |

### 讨论

用户倾向于选择简单或常用的密码，这些密码容易记住。令人惊讶的是，一些人仍在使用“123456”和“password”作为他们的密码，这意味着他们很容易被破解。因此，通常有必要通过实施最小密码复杂度要求来防止用户选择容易猜测的密码。

我们将每个验证规则都结构化为独立的前瞻组。如果没有前瞻，你将需要使用多个正则表达式模式，或者多次遍历字符串来检查所有需要的条件，这样不仅效率较低，而且难以维护。

前瞻允许你检查条件，而不实际推进正则引擎在字符串中的位置，因此每个测试都从字符串的起始位置开始。一旦前瞻成功，正则引擎会继续从相同的位置测试下一个前瞻。如果前瞻未能找到匹配项，则整个匹配会失败。

要搜索一个模式，每个前瞻都有一个“.*”，这意味着要查找的字符类型可以出现在字符串中的任何位置，而不仅仅是在开头。通过这里展示的技巧，你可以在单个正则表达式中包含多个密码测试。

记住，验证表单输入时，客户端和服务器端脚本都很重要。客户端验证可以为用户提供即时反馈，并防止错误数据提交到服务器。但这种类型的验证可能被用户绕过或操控，无论是故意还是无意的，因此不能仅依赖它作为唯一的验证方式。
