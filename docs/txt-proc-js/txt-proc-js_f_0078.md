| 配方 66 | 转义字符串以用于正则表达式 |
| --- | --- |

### 任务

想象一下你正在为一个在线书店设计搜索功能。在应用的搜索功能中，有一个字段允许用户输入部分书名或作者名，以查找他们正在寻找的特定书籍。

你的代码涉及将用户提供的字符串作为正则表达式的一个组成部分来搜索数据库。为了保护你的应用免受潜在攻击，你应该实现一个函数，在将用户提供的字符串作为搜索模式的组成部分之前，先转义其中的所有正则元字符。

转义确保字符串中的特殊字符得到正确处理，不会无意中影响正则表达式的行为。

### 解决方案

为了确保在模式中具有特殊含义的字符被当作普通字符处理，不进行特殊解释，你可以创建一个函数，在这些字符前添加反斜杠：

[part_3/escaping_metacharacters/escaping_ex1.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/escaping_metacharacters/escaping_ex1.js)

|   | **function** escapeRegex(str) { |
| --- | --- |
|   | **const** re = */**[**-**\\**^$*+?.()&#124;[**\]**{}**]**/g*; |
|   | **return** str.replace(re, *"***\\***$&"*); |
|   | } |
|   |  |
|   | **const** str = *"这些字符应该被转义： -* **\\** *^ $ * + ? . ( ) &#124; [ ] { }"*; |
|   | **const** escaped = escapeRegex(str); |
|   |  |
|   | console.log(escaped); |
|   | *// → "这些字符应该被转义：\- \\ \^ \$ \* \+ \? \. \( \) \&#124; \[ \] \{ \}"* |

该字符串现在可以安全地用作正则表达式的一部分。

### 讨论

这个配方的正则表达式将所有的正则元字符封装在一个字符类中。方括号 [] 表示一个字符类，意味着类中的任何字符都将被匹配。然后，replace() 方法将所有的元字符替换为其转义版本。

替换字符串中的 $& 表示匹配的子字符串本身。注意它前面的双反斜杠：由于反斜杠作为转义字符，如果你想在字符串中添加字面上的反斜杠，不能直接使用它。相反，你需要输入两个连续的反斜杠。这是因为第一个反斜杠充当第二个反斜杠的转义字符，告诉 JavaScript 将第二个反斜杠视为字面字符，而不是转义序列。

下面是转义字符类中每个符号的理由：

+   - 连字符符号在字符类中定义了一个字符范围。为了防止在字符类中无意间创建范围，必须对其进行转义。

+   \ 反斜杠可用于将某些字面字符转化为特殊字符。例如，\n 创建一个换行符（而不是反斜杠后跟字母 n）

+   ^ 脱字符号匹配行/字符串的开头。它也可以创建一个否定的字符类

+   $ 美元符号匹配行/字符串的结尾

+   * *量词匹配其前面的项零次或多次

+   + +量词匹配其前面的项一次或多次

+   ? ?量词匹配其前面的项零次或一次

+   . 点号符号匹配任何字符

+   | 垂直条符号匹配两个或更多选项中的任意一个

+   () 圆括号用于捕获、分组和其他构造

+   [] 方括号用于创建字符类

+   {} 大括号用于创建量词

使用此配方中的模式时，确保使用 g 标志以替换所有匹配项，而不仅仅是第一个。

在使用用户提供的输入进行正则表达式匹配时，要特别小心。否则，可能会使程序容易受到一种叫做 ReDos（正则表达式拒绝服务攻击）的攻击。攻击者可能会通过提供一个极其复杂的正则表达式来利用程序，这会导致处理过程需要大量时间。

当在浏览器中评估用户输入时，ReDoS攻击通常会导致浏览器卡死。但是，当输入在服务器上进行评估时，后果可能更为严重，甚至可能导致拒绝服务攻击。在这种攻击中，攻击者会向服务器发送大量计算密集型的请求，从而有效地阻止服务器处理合法请求。

在这种情况下，保护你的程序免受ReDoS攻击并不困难：只需转义所有可能改变表达式模式的元字符。可以通过在元字符前加上反斜杠来实现，这样正则表达式引擎就会把它当作字面字符处理。

| 在其他语言中转义元字符 |
| --- |
| ![images/aside-icons/tip.png](images/aside-icons/tip.png) | 在一些编程语言中，存在内置函数可以自动转义正则表达式元字符。例如，Java中有Pattern.quote(str)，Python提供了e.escape(str)。如果你使用Lodash库，你也可以利用它的_.escapeRegExp()方法来转义元字符。 |
