|   | 食谱59 | 删除重复行 |
| --- | --- | --- |

### 任务

假设你需要在网站上显示球队排名，但你的数据是从另一个来源导入的，并且在导入过程中出现了错误。现在，你的新文档中有连续的重复行。

举个例子，假设你导入的数据包含以下几行：

|   | 团队排名 |
| --- | --- |
|   | #1 克利夫兰骑士 45-28 |
|   | #2 费城76人 48-22 |
|   | #2 费城76人 48-22 |
|   | #3 孟菲斯灰熊 43-27 |
|   | #4 波士顿凯尔特人 49-23 |
|   | #4 波士顿凯尔特人 49-23 |
|   | #4 波士顿凯尔特人 49-23 |

在显示排名之前，你需要删除重复项，以便它以如下方式显示：

|   | 团队排名 |
| --- | --- |
|   | #1 克利夫兰骑士 45-28 |
|   | #2 费城76人 48-22 |
|   | #3 孟菲斯灰熊 43-27 |
|   | #4 波士顿凯尔特人 49-23 |

你需要一个正则表达式，它能够检测到两行相同并删除其中一行。

### 解决方案

使用以下函数：

[part_3/removing_dup_lines_v1/dup_lines_v1_ex1.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/removing_dup_lines_v1/dup_lines_v1_ex1.js)

|   | **function** removeDuplicateLines(str) { |
| --- | --- |
|   | **const** re = */^**(**.***)(?:\r?\n\1)**+$/mg*; |
|   | **return** str.replace(re, *"$1"*); |
|   | } |
|   |  |
|   | **const** str = |
|   | *`团队排名* |
|   | *#1 克利夫兰骑士 45-28* |
|   | *#2 费城76人 48-22* |
|   | *#2 费城76人 48-22* |
|   | *#3 孟菲斯灰熊 43-27* |
|   | *#4 波士顿凯尔特人 49-23* |
|   | *#4 波士顿凯尔特人 49-23* |
|   | *#4 波士顿凯尔特人 49-23`*; |
|   |  |
|   | **const** result = removeDuplicateLines(str); |
|   |  |
|   | console.log(result); |
|   | *// 团队排名* |
|   | *// #1 克利夫兰骑士 45-28* |
|   | *// #2 费城76人 48-22* |
|   | *// #3 孟菲斯灰熊 43-27* |
|   | *// #4 波士顿凯尔特人 49-23* |

这将输出去除重复行后的字符串。

### 讨论

要使用正则表达式匹配行的开始，我们在开头使用符号 ^。通常，^ 只匹配字符串的开始，因此启用多行标志 (m) 是很重要的，这样 ^ 和 $ 才能在换行符处匹配。此外，确保不要使用 dotAll 标志 (s)，因为它允许点符号匹配换行符，否则会导致正则表达式匹配整个字符串。

我们使用一对括号包含 .* 来匹配一整行的内容，包括空行。由于括号是一个捕获组，我们可以稍后使用反向引用来引用匹配的值。

在一个非捕获组 (?: ... ) 中，我们使用模式 \r?\n\1 来识别在 Unix 和类 Unix 系统（\n）或 Windows/DOS（\r\n）文本文件中找到的行分隔符。接下来，我们尝试匹配之前匹配的行，使用反向引用 \1。

如果该位置的行不匹配，匹配过程失败，正则引擎将继续尝试下一个匹配。相反，如果找到匹配项，我们使用 + 量词来重复该组，该组由换行符和反向引用组成，用于匹配任何后续的相同行。

以下是正则表达式模式的分解：

|   | /^(.*)(?:\r?\n\1)+$/mg; |
| --- | --- |
|   |  |
|   | ● ^ 确认行的开始 |
|   | ● (.*) 第一个捕获组 |
|   | ○ . 匹配除行终止符之外的任意字符 |
|   | ○ * 匹配前一个符号零次或多次 |
|   | ● (?:\r?\n\1) 非捕获组 |
|   | ○ \r 匹配回车符 |
|   | ○ ? 匹配前一个符号零次或一次 |
|   | ○ \n 匹配换行符（newline）字符 |
|   | ○ \1 匹配由第一个捕获组匹配的相同文本 |
|   | ● + 匹配前一个符号一次或多次 |
|   | ● $ 确认行的结束 |
|   | ● 标志 |
|   | ○ m: 启用多行模式，使 ^ 和 $ 匹配行的开始和结束 |
|   | ○ g: 启用全局匹配，返回所有匹配项 |

由于我们正在执行搜索和替换操作，完整匹配项（包括原始行和任何换行符）会从字符串中删除。为了恢复初始行，我们在 `replace()` 的第二个参数中使用特殊的替换模式 $1。

使用这种技术删除重复行很快，但它不会删除由其他行隔开的重复行。下一个示例将向你展示如何使用 JavaScript 的内置方法做到这一点。
