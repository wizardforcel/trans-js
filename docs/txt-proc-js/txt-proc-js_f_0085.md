| 食谱 73 | 将纯文本转换为 HTML 准备好的标记语言 |
| --- | --- |

### 任务

假设你打算在网页上显示用户输入的文本。网页编程中一个让人头痛的问题是 HTML 与纯文本之间缺乏兼容性，尽管它们经常可以互换使用。虽然人们可能会在表单的文本框中输入纯文本格式的信息，但你很可能希望以 HTML 格式显示相同的信息。举个例子，假设用户在论坛页面上输入了一个问题：

|   | 嘿，大家， |
| --- | --- |
|   |  |
|   | 我需要你的帮助，有件紧急的事情。我的猫，胡须先生，最近一直表现得很奇怪。 |
|   | 最近他的表现很奇怪。一直不停地喵喵叫，还一直推倒我的植物， |
|   | 更糟糕的是，他还偷我的袜子。 |
|   |  |
|   | 你知道有什么好的猫咪治疗师可以推荐吗？ |
|   |  |
|   | 谢谢 |

如果你没有在标记中包含 <br> 或 <p> 标签来表示换行，加载到网页浏览器中的显示效果将是这样的：

|   | 嘿，大家，我需要你们的帮助，有件紧急的事情。我的猫，胡须先生， |
| --- | --- |
|   | 最近他表现得非常奇怪。一直不停地喵喵叫，还一直推倒我的植物， |
|   | 我的猫一直很奇怪，最近不停地喵喵叫，还一直推倒我的植物，更糟糕的是，他还偷我的袜子。你知道 |
|   | 有什么好的猫咪治疗师可以推荐吗？谢谢 |

你需要的是一个添加相关 HTML 标签来处理段落的解决方案。

### 解决方案

在提供的文本中搜索换行符，并用 HTML 标签替换它们：

[part_3/converting_text_to_html/text_to_html_ex1.js](http://media.pragprog.com/titles/fkjavascript/code/part_3/converting_text_to_html/text_to_html_ex1.js)

| 1:  | **function** convertTextToHTML(str) { |
| --- | --- |
| -  |  |
| -  | *// 用 <br> 替换换行符* |
| -  | str = str.replace(*/**\r\n**&#124;**\n**/g*, *"<br>"*); |
| 5:  |  |
| -  | *// 用 </p><p> 替换连续的两个 <br>* |
| -  | str = str.replace(*/<br>**\s***<br>/g*, *"</p><p>"*); |
| -  |  |
| -  | *// 将整个字符串包裹在 <p></p> 中* |
| 10:  | str = *`<p>*${str}*</p>`*; |
| -  | **返回** str; |
| -  | } |
| -  |  |
| -  | **const** str = |
| 15:  | *`嘿，大家，* |
| -  |  |
| -  | *我有件紧急的事需要你们帮忙。我的猫，Whiskers，最近一直表现得很奇怪，* |
| -  | *最近超级奇怪。他不停地喵喵叫，还是一直把我的植物弄倒，* |
| -  | *而且最糟糕的是，他一直在偷我的袜子。* |
| 20:  |  |
| -  | *你知道有什么好的猫咪治疗师可以推荐吗？* |
| -  |  |
| -  | *谢谢* |
| -  | *`*; |
| 25:  |  |
| -  | convertTextToHTML(str); |
| -  | *// → <p>嘿，大家，</p><p>我有件紧急的事需要你们帮忙。我的猫，* |
| -  | *// Whiskers 最近超级奇怪。他不停地喵喵叫，* |
| -  | *// 他不停地把我的植物弄倒，<br>而且最糟糕的是，他一直在* |
| 30:  | *// 偷我的袜子。 </p><p>你知道有什么好的猫咪治疗师可以推荐吗？* |
| -  | *// 可以推荐吗？</p><p>谢谢<br></p>"* |

现在，添加了 HTML 标签后，文本将在浏览器中正确显示。

### 讨论

重新使用用户提供的文本而不进行清理是不明智的，因为这样会让系统容易受到 XSS 攻击。但对于这个示例，我们忽略这个问题，假设输入是安全的（如果你想了解如何防止 XSS 攻击，查看脚注中的链接^([[36]](f_0087.xhtml#FOOTNOTE-36))）。

我们首先使用正则表达式 /\r\n|\n/g 来查找在 Microsoft Windows/DOS (\r\n) 或 Unix 和类 Unix 系统 (\n) 中使用的换行符。然后将它们替换为 <br>。

为了在 HTML 中格式化段落，必须将它们包含在 <p></p> 标签中。实现这一点的一种方法是找到两个连续换行符的实例，并用 </p><p> 替换它们（第 7 行）。

最后，我们用<p></p>标签包裹完整的字符串，然后返回生成的字符串。在使用此函数将文本转换为HTML之前，你可能需要将&、<、>、"和’字符替换为HTML实体，以防止浏览器将用户输入的HTML标签误解为实际的HTML标签（参见食谱8，[*使用replaceAll()将HTML标记转换为HTML实体*](f_0018.xhtml#rcp.entities)）。
